rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- Helper Functions ---
    // Check if user is signed in
    function isAuthenticated() {
      return request.auth != null;
    }

    // Check if user is the owner of the document (assuming doc ID is UID or field 'id' matches)
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    // Check if user has 'ADMIN' role in their user profile
    function isAdmin() {
      return isAuthenticated() && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // --- Collection Rules ---

    // USERS: Users can read profiles (needed for networking), but only edit their own.
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow write: if isOwner(userId);
    }

    // VENDORS: Public read. Admin write only.
    match /vendors/{vendorId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // MENU ITEMS: Public read. Admin write only.
    match /menu_items/{itemId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // REVIEWS: Public read. Authenticated create. Admin or Owner delete.
    match /reviews/{reviewId} {
      allow read: if true;
      allow create: if isAuthenticated() && request.resource.data.user_id == request.auth.uid;
      // Allow update only by owner
      allow update: if isAuthenticated() && request.resource.data.user_id == request.auth.uid; 
      // Delete by owner or admin (moderation)
      allow delete: if isAuthenticated() && (resource.data.user_id == request.auth.uid || isAdmin());
    }

    // MEAL SPLITS: Authenticated read/create. Owner update/delete.
    match /meal_splits/{splitId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && request.resource.data.created_by == request.auth.uid;
      allow update, delete: if isAuthenticated() && resource.data.created_by == request.auth.uid;
    }

    // MESSAGES: Private between sender and receiver.
    match /messages/{messageId} {
      // Allow read if you are the sender OR the receiver
      allow read: if isAuthenticated() && (resource.data.sender_id == request.auth.uid || resource.data.receiver_id == request.auth.uid);
      // Allow create if you are the sender
      allow create: if isAuthenticated() && request.resource.data.sender_id == request.auth.uid;
    }
  }
}
